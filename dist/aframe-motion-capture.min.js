!function(t){function e(r){if(i[r])return i[r].exports;var o=i[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");i(3),i(4),i(1),i(2),i(5),i(6)},function(t,e){AFRAME.registerComponent("avatar-recorder",{schema:{autoRecording:{default:!1},autoPlay:{default:!1},localStorage:{default:!1},binaryFormat:{default:!1}},init:function(){var t=this;this.trackedControllerEls={},this.onKeyDown=this.onKeyDown.bind(this),this.tick=AFRAME.utils.throttle(this.throttledTick,100,this),this.el.addEventListener("camera-set-active",function(e){t.cameraEl=e.detail.cameraEl,t.cameraEl.setAttribute("motion-capture-recorder",{autoStart:!0,visibleStroke:!1})})},playRecording:function(){var t,e=this.el;this.data.autoPlay&&(t=JSON.parse(localStorage.getItem("avatar-recording"))||this.recordingData,t&&(e.setAttribute("avatar-replayer",{loop:!0}),e.components["avatar-replayer"].startPlaying(t)))},stopPlayRecording:function(){var t=this.el.components["avatar-replayer"];t&&t.stopPlaying()},throttledTick:function(){var t=this,e=this.el.querySelectorAll("[tracked-controls]");e.forEach(function(e){return e.id?void(t.trackedControllerEls[e.id]||(e.setAttribute("motion-capture-recorder",{autoStart:!0,visibleStroke:!1}),t.trackedControllerEls[e.id]=e,this.isRecording&&e.components["motion-capture-recorder"].startRecording())):void console.warn("Player Recorder: Found tracked controllers with no id. It will not be recorded")})},play:function(){this.playRecording(),window.addEventListener("keydown",this.onKeyDown)},pause:function(){window.removeEventListener("keydown",this.onKeyDown)},onKeyDown:function(t){var e=t.keyCode;if(32===e||80===e||67===e)switch(e){case 32:this.toggleRecording();break;case 80:this.togglePlaying();break;case 67:localStorage.removeItem("avatar-recording")}},togglePlaying:function(){var t=this.el.components["avatar-replayer"];t.isPlaying?this.stopPlayRecording():this.playRecording()},toggleRecording:function(){this.isRecording?this.stopRecording():this.startRecording()},startRecording:function(){var t=this.trackedControllerEls,e=Object.keys(t);this.isRecording||(this.stopPlayRecording(),this.isRecording=!0,this.cameraEl.components["motion-capture-recorder"].startRecording(),e.forEach(function(e){t[e].components["motion-capture-recorder"].startRecording()}))},stopRecording:function(){var t=this.trackedControllerEls,e=Object.keys(t);this.isRecording&&(this.isRecording=!1,this.cameraEl.components["motion-capture-recorder"].stopRecording(),e.forEach(function(e){t[e].components["motion-capture-recorder"].stopRecording()}),this.saveRecording(),this.data.autoPlay&&this.playRecording())},getJSONData:function(){var t={},e=this.trackedControllerEls,i=Object.keys(e);if(!this.isRecording)return this.isRecording=!1,t.camera=this.cameraEl.components["motion-capture-recorder"].getJSONData(),i.forEach(function(i){t[i]=e[i].components["motion-capture-recorder"].getJSONData()}),this.recordingData=t,t},saveRecording:function(){var t=this.getJSONData();this.data.localStorage?this.saveToLocalStorage(t):this.saveRecordingFile(t)},saveToLocalStorage:function(t){localStorage.setItem("avatar-recording",JSON.stringify(t))},saveRecordingFile:function(t){var e=JSON.stringify(t),i=this.data.binaryFormat?"application/octet-binary":"application/json",r=new Blob([e],{type:i}),o=URL.createObjectURL(r),n="player-recording-"+document.title+"-"+Date.now()+".json",s=document.createElement("a");s.href=o,s.setAttribute("download",n),s.innerHTML="downloading...",s.style.display="none",document.body.appendChild(s),setTimeout(function(){s.click(),document.body.removeChild(s)},1)}})},function(t,e){AFRAME.registerComponent("avatar-replayer",{schema:{src:{default:""},loop:{default:!1}},update:function(t){var e=this.data;e.src&&t.src!==e.src&&this.updateSrc(e.src)},updateSrc:function(t){this.loadRecordingFromUrl(t,!1,this.startPlaying.bind(this))},startPlaying:function(t){var e,i=this,r=this.el;return this.recordingData=t,this.isPlaying=!0,this.el.camera?void Object.keys(t).forEach(function(i){return"camera"===i?(r.camera.el.setAttribute("motion-capture-replayer",{loop:!1}),void r.camera.el.components["motion-capture-replayer"].startPlaying(t.camera)):(e=r.querySelector("#"+i),e||console.warn("Avatar Player: No element with id "+i),e.setAttribute("motion-capture-replayer",{loop:!1}),void e.components["motion-capture-replayer"].startPlaying(t[i]))}):void this.el.addEventListener("camera-set-active",function(){i.startPlaying(t)})},stopPlaying:function(){var t,e=this;this.isPlaying&&this.recordingData&&(this.isPlaying=!1,t=Object.keys(this.recordingData),t.forEach(function(t){"camera"===t?e.el.camera.el.components["motion-capture-replayer"].stopPlaying():(el=document.querySelector("#"+t),el||console.warn("Avatar Player: No element with id "+t),el.components["motion-capture-replayer"].stopPlaying())}))},loadRecordingFromUrl:function(t,e,i){var r,o=new THREE.FileLoader(this.manager),n=this;o.crossOrigin="anonymous",e===!0&&o.setResponseType("arraybuffer"),o.load(t,function(t){r=e===!0?n.loadStrokeBinary(t):JSON.parse(t),i&&i(r)})}})},function(t,e){var i={axismove:{id:0,props:["id","axis"]},buttonchanged:{id:1,props:["id","state"]},buttondown:{id:2,props:["id","state"]},buttonup:{id:3,props:["id","state"]},touchstart:{id:4,props:["id","state"]},touchend:{id:5,props:["id","state"]}};AFRAME.registerComponent("motion-capture-recorder",{schema:{enabled:{default:!0},hand:{default:"right"},visibleStroke:{default:!0},persistStroke:{default:!1},autoStart:{default:!1}},init:function(){this.drawing=!1,this.recordedEvents=[],this.recordedPoses=[],this.addEventListeners()},addEventListeners:function(){var t=this.el;this.recordEvent=this.recordEvent.bind(this),t.addEventListener("axismove",this.recordEvent),t.addEventListener("buttonchanged",this.onTriggerChanged.bind(this)),t.addEventListener("buttonchanged",this.recordEvent),t.addEventListener("buttonup",this.recordEvent),t.addEventListener("buttondown",this.recordEvent),t.addEventListener("touchstart",this.recordEvent),t.addEventListener("touchend",this.recordEvent)},recordEvent:function(t){var e;this.isRecording&&(e={},i[t.type].props.forEach(function(i){e[i]=t.detail[i]}),this.recordedEvents.push({name:t.type,detail:e,timestamp:this.lastTimestamp}))},onTriggerChanged:function(t){var e,i=this.data;if(i.enabled&&!i.autoStart&&1===t.detail.id)return e=t.detail.state.value,e<=.1?void(this.isRecording&&this.stopRecording()):void(this.isRecording||this.startRecording())},getJSONData:function(){if(this.recordedPoses)return{poses:this.system.getStrokeJSON(this.recordedPoses),events:this.recordedEvents}},saveCapture:function(t){var e=JSON.stringify(this.getJSONData()),i=t?"application/octet-binary":"application/json",r=new Blob([e],{type:i}),o=URL.createObjectURL(r),n="motion-capture-"+document.title+"-"+Date.now()+".json",s=document.createElement("a");s.setAttribute("class","motion-capture-download"),s.href=o,s.setAttribute("download",n),s.innerHTML="downloading...",s.style.display="none",document.body.appendChild(s),setTimeout(function(){s.click(),document.body.removeChild(s)},1)},update:function(){var t=this.el,e=this.data;this.data.autoStart?this.startRecording():(t.setAttribute("vive-controls",{hand:e.hand}),t.setAttribute("oculus-touch-controls",{hand:e.hand}),t.setAttribute("stroke",{hand:e.hand}))},tick:function(){var t=new THREE.Vector3,e=new THREE.Quaternion,i=new THREE.Vector3;return function(r,o){var n,s;this.lastTimestamp=r,this.data.enabled&&this.isRecording&&(n={position:this.el.getAttribute("position"),rotation:this.el.getAttribute("rotation"),timestamp:r},this.recordedPoses.push(n),this.data.visibleStroke&&(this.el.object3D.updateMatrixWorld(),this.el.object3D.matrixWorld.decompose(t,e,i),s=this.getPointerPosition(t,e),this.el.components.stroke.drawPoint(t,e,r,s)))}}(),getPointerPosition:function(){var t=new THREE.Vector3,e=new THREE.Vector3(0,.7,1);return function(i,r){var o=e.clone().applyQuaternion(r).normalize().multiplyScalar(-.03);return t.copy(i).add(o),t}}(),startRecording:function(){var t=this.el;this.isRecording||(t.components.stroke&&t.components.stroke.reset(),this.isRecording=!0,this.recordedPoses=[],this.recordedEvents=[],t.emit("strokestarted",{entity:t,poses:this.recordedPoses}))},stopRecording:function(){var t=this.el;this.isRecording&&(t.emit("strokeended",{poses:this.recordedPoses}),this.isRecording=!1,this.data.visibleStroke&&!this.data.persistStroke&&t.components.stroke.reset())}})},function(t,e){function i(t,e){t.setAttribute("position",e.position),t.setAttribute("rotation",e.rotation)}AFRAME.registerComponent("motion-capture-replayer",{schema:{enabled:{default:!0},recorderEl:{type:"selector"},loop:{default:!0},src:{default:""}},init:function(){this.currentPoseTime=0,this.currentEventTime=0,this.currentPoseIndex=0,this.currentEventIndex=0,this.onStrokeStarted=this.onStrokeStarted.bind(this),this.onStrokeEnded=this.onStrokeEnded.bind(this),this.discardedFrames=0,this.playingEvents=[],this.playingPoses=[]},update:function(t){var e=this.data;this.updateRecorder(e.recorderEl,t.recorderEl),t.src!==e.src&&e.src&&this.updateSrc(e.src)},updateRecorder:function(t,e){e&&e!==t&&(e.removeEventListener("strokestarted",this.onStrokeStarted),e.removeEventListener("strokeended",this.onStrokeEnded)),t&&e!==t&&(t.addEventListener("strokestarted",this.onStrokeStarted),t.addEventListener("strokeended",this.onStrokeEnded))},updateSrc:function(t){this.el.sceneEl.systems["motion-capture-recorder"].loadRecordingFromUrl(t,!1,this.startPlaying.bind(this))},onStrokeStarted:function(t){this.reset()},onStrokeEnded:function(t){this.startPlaying({poses:t.detail.poses,events:[]})},play:function(){this.playingStroke&&this.startPlaying(this.playingStroke)},startPlaying:function(t){this.ignoredFrames=0,this.storeInitialPose(),this.startPlayingPoses(t.poses),this.startPlayingEvents(t.events)},stopPlaying:function(){this.isPlaying=!1,this.restoreInitialPose()},storeInitialPose:function(){var t=this.el;this.initialPose={position:t.getAttribute("position"),rotation:t.getAttribute("rotation")}},restoreInitialPose:function(){var t=this.el;this.initialPose&&(t.setAttribute("position",this.initialPose.position),t.setAttribute("rotation",this.initialPose.rotation))},startPlayingPoses:function(t){this.isPlaying=!0,this.currentPoseIndex=0,this.playingPoses=t,this.currentPoseTime=t[0].timestamp},startPlayingEvents:function(t){var e;this.isPlaying=!0,this.currentEventIndex=0,this.playingEvents=t,e=t[0],e&&(this.currentEventTime=e.timestamp,this.el.emit(e.name,e.detail))},reset:function(){this.playingPoses=null,this.currentTime=void 0,this.currentPoseIndex=void 0},playRecording:function(t){var e,r,o=this.playingPoses,n=this.playingEvents;for(e=o&&o[this.currentPoseIndex],r=n&&n[this.currentEventIndex],this.currentPoseTime+=t,this.currentEventTime+=t;e&&this.currentPoseTime>=e.timestamp;)this.data.loop&&this.currentPoseIndex===o.length-1&&this.restart(),i(this.el,e),this.currentPoseIndex+=1,e=o[this.currentPoseIndex];for(;r&&this.currentEventTime>=r.timestamp;)this.el.emit(r.name,r.detail),this.currentEventIndex+=1,r=this.playingEvents[this.currentEventIndex]},restart:function(){this.currentPoseIndex=0,this.currentPoseTime=this.playingPoses[0].timestamp,this.currentEventIndex=0,this.currentEventTime=this.playingEvents[0]?this.playingEvents[0].timestamp:0},tick:function(t,e){return 2===this.ignoredFrames||window.debug?void(this.isPlaying&&this.playRecording(e)):void this.ignoredFrames++}})},function(t,e){AFRAME.registerComponent("stroke",{schema:{enabled:{default:!0},color:{default:"#ef2d5e",type:"color"}},init:function(){var t,e=this.maxPoints=3e3;this.idx=0,this.numPoints=0,this.vertices=new Float32Array(3*e*3),this.normals=new Float32Array(3*e*3),this.uvs=new Float32Array(2*e*2),this.geometry=new THREE.BufferGeometry,this.geometry.setDrawRange(0,0),this.geometry.addAttribute("position",new THREE.BufferAttribute(this.vertices,3).setDynamic(!0)),this.geometry.addAttribute("uv",new THREE.BufferAttribute(this.uvs,2).setDynamic(!0)),this.geometry.addAttribute("normal",new THREE.BufferAttribute(this.normals,3).setDynamic(!0)),this.material=new THREE.MeshStandardMaterial({color:this.data.color,roughness:.75,metalness:.25,side:THREE.DoubleSide});var i=new THREE.Mesh(this.geometry,this.material);i.drawMode=THREE.TriangleStripDrawMode,i.frustumCulled=!1,t=document.createElement("a-entity"),t.setObject3D("stroke",i),this.el.sceneEl.appendChild(t)},update:function(){this.material.color.set(this.data.color)},drawPoint:function(){var t=new THREE.Vector3,e=new THREE.Vector3,r=new THREE.Vector3;new THREE.Vector3,new THREE.Vector3;return function(o,n,s,a){var c=0,d=this.numPoints,h=.01;if(d!==this.maxPoints){for(i=0;i<d;i++)this.uvs[c++]=i/(d-1),this.uvs[c++]=0,this.uvs[c++]=i/(d-1),this.uvs[c++]=1;return t.set(1,0,0),t.applyQuaternion(n),t.normalize(),e.copy(a),r.copy(a),e.add(t.clone().multiplyScalar(h/2)),r.add(t.clone().multiplyScalar(-h/2)),this.vertices[this.idx++]=e.x,this.vertices[this.idx++]=e.y,this.vertices[this.idx++]=e.z,this.vertices[this.idx++]=r.x,this.vertices[this.idx++]=r.y,this.vertices[this.idx++]=r.z,this.computeVertexNormals(),this.geometry.attributes.normal.needsUpdate=!0,this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.uv.needsUpdate=!0,this.geometry.setDrawRange(0,2*d),this.numPoints+=1,!0}}}(),reset:function(){var t=0,e=this.vertices;for(i=0;i<this.numPoints;i++)e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0;this.geometry.setDrawRange(0,0),this.idx=0,this.numPoints=0},computeVertexNormals:function(){for(var t=new THREE.Vector3,e=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3,o=new THREE.Vector3,n=0,s=this.idx;n<s;n++)this.normals[n]=0;var a=!0;for(n=0,s=this.idx;n<s;n+=3)a?(t.fromArray(this.vertices,n),e.fromArray(this.vertices,n+3),i.fromArray(this.vertices,n+6)):(t.fromArray(this.vertices,n+3),e.fromArray(this.vertices,n),i.fromArray(this.vertices,n+6)),a=!a,r.subVectors(i,e),o.subVectors(t,e),r.cross(o),r.normalize(),this.normals[n]+=r.x,this.normals[n+1]+=r.y,this.normals[n+2]+=r.z,this.normals[n+3]+=r.x,this.normals[n+4]+=r.y,this.normals[n+5]+=r.z,this.normals[n+6]+=r.x,this.normals[n+7]+=r.y,this.normals[n+8]+=r.z;for(n=6,s=this.idx-6;n<s;n++)this.normals[n]=this.normals[n]/3;this.normals[3]=this.normals[3]/2,this.normals[4]=this.normals[4]/2,this.normals[5]=this.normals[5]/2,this.normals[this.idx-6]=this.normals[this.idx-6]/2,this.normals[this.idx-6+1]=this.normals[this.idx-6+1]/2,this.normals[this.idx-6+2]=this.normals[this.idx-6+2]/2,this.geometry.normalizeNormals()}})},function(t,e){AFRAME.registerSystem("motion-capture-recorder",{init:function(){this.strokes=[]},undo:function(){var t=this.strokes.pop();if(t){var e=t.entity;e.emit("stroke-removed",{entity:e}),e.parentNode.removeChild(e)}},clear:function(){for(var t=0;t<this.strokes.length;t++){var e=this.strokes[t].entity;e.parentNode.removeChild(e)}this.strokes=[]},generateRandomStrokes:function(t){function e(){return 2*Math.random()-1}for(var i=0;i<t;i++)for(var r=parseInt(500*Math.random()),o=[],n=new THREE.Vector3(e(),e(),e()),s=new THREE.Vector3,a=new THREE.Quaternion,c=.2,d=0;d<r;d++){s.set(e(),e(),e()),s.multiplyScalar(e()/20),a.setFromUnitVectors(n.clone().normalize(),s.clone().normalize()),n=n.add(s);var h=0,l=this.getPointerPosition(n,a);o.addPoint(n,a,l,c,h)}},saveStroke:function(t){this.strokes.push(t)},getPointerPosition:function(){var t=new THREE.Vector3,e=new THREE.Vector3(0,.7,1);return function(i,r){var o=e.clone().applyQuaternion(r).normalize().multiplyScalar(-.03);return t.copy(i).add(o),t}}(),getJSON:function(){var t={version:VERSION,strokes:[],author:""};for(i=0;i<this.strokes.length;i++)t.strokes.push(this.strokes[i].getJSON(this));return t},getStrokeJSON:function(t){for(var e,i=[],r=0;r<t.length;r++)e=t[r],i.push({position:e.position,rotation:e.rotation,timestamp:e.timestamp});return i},getBinary:function(){var t=[],e="apainter",i=this.strokes=[],r=e.length,o=new BinaryManager(new ArrayBuffer(r));o.writeString(e),o.writeUint16(VERSION),o.writeUint32(this.strokes.length),t.push(o.getDataView());for(var n=0;n<i.length;n++)t.push(this.getStrokeBinary(i[n]));return t},getStrokeBinary:function(t){var e=4+36*t.length,i=new BinaryManager(new ArrayBuffer(e));i.writeUint32(t.length);for(var r=0;r<t.length;r++){var o=t[r];i.writeFloat32Array(o.position.toArray()),i.writeFloat32Array(o.orientation.toArray()),i.writeUint32(o.timestamp)}return i.getDataView()},loadJSON:function(t){var e;t.version!==VERSION&&console.error("Invalid version: ",version,"(Expected: "+VERSION+")");for(var i=0;i<t.strokes.length;i++)e=t.strokes[i],this.loadStrokeJSON(t.strokes[i])},loadBinary:function(t){var e=new BinaryManager(t),i=e.readString();if("apainter"!==i)return void console.error("Invalid `magic` header");var r=e.readUint16();r!==VERSION&&console.error("Invalid version: ",r,"(Expected: "+VERSION+")");for(var o=e.readUint32(),n=0;n<o;n++)for(var s=e.readUint32(),a=[],c=0;c<s;c++){var d=e.readVector3();e.readQuaternion(),e.readUint32();a.push({position:d,rotation:rotation,timestamp:time})}},loadRecordingFromUrl:function(t,e,i){var r,o=new THREE.XHRLoader(this.manager),n=this;o.crossOrigin="anonymous",e===!0&&o.setResponseType("arraybuffer"),o.load(t,function(t){r=e===!0?n.loadStrokeBinary(t):JSON.parse(t),i&&i(r)})},loadFromUrl:function(t,e){var i=new THREE.XHRLoader(this.manager),r=this;i.crossOrigin="anonymous",e===!0&&i.setResponseType("arraybuffer"),i.load(t,function(t){e===!0?r.loadBinary(t):r.loadJSON(JSON.parse(t))})}})}]);